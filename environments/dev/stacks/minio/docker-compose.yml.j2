version: "3.8"

networks:
  minio_network:
    driver: overlay

services:
  minio:
    image: minio/minio:RELEASE.2025-07-23T15-54-02Z
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD_FILE=/run/secrets/minio_root_password
      - MINIO_SERVER_URL=https://minio.{{ DOMAIN_SUFFIX }}
      - MINIO_BROWSER_REDIRECT_URL=https://minio-console.{{ DOMAIN_SUFFIX }}
    secrets:
      - minio_root_password
    volumes:
      - minio_data:/data
    networks:
      - traefik_network
      - minio_network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == minio
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.minio-api.rule=Host(`minio.{{ DOMAIN_SUFFIX }}`)"
        - "traefik.http.routers.minio-api.entrypoints=websecure"
        - "traefik.http.routers.minio-api.tls.certresolver=letsencrypt"
        - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
        - "traefik.http.routers.minio-console.rule=Host(`minio-console.{{ DOMAIN_SUFFIX }}`)"
        - "traefik.http.routers.minio-console.entrypoints=websecure"
        - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
        - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

volumes:
  minio_data:

secrets:
  minio_root_password:
    external: true
