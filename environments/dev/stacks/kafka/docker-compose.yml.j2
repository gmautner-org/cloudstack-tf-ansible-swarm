version: "3.8"

services:
  kafbat-ui:
    image: ghcr.io/kafbat/kafka-ui:latest
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: broker-1:19092,broker-2:19092,broker-3:19092
      DYNAMIC_CONFIG_ENABLED: 'true'
    networks:
      - kafka_network
      - traefik_network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == kafbat
      labels:
        - traefik.enable=true
        - traefik.http.routers.kafbat.rule=Host(`kafbat.{{ domain_suffix }}`)
        - traefik.http.routers.kafbat.entrypoints=websecure
        - traefik.http.routers.kafbat.tls.certresolver=letsencrypt
        - traefik.http.services.kafbat.loadbalancer.server.port=8080

  controller-1:
    image: apache/kafka:latest
    networks:
      - kafka_network
    environment:
      CLUSTER_ID: "3D2ECDCE-8653-4164-A05B-50FBD8F5B915"
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: controller
      KAFKA_LISTENERS: CONTROLLER://:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@controller-1:9093,2@controller-2:9093,3@controller-3:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    volumes:
      - controller-1_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == controller-1

  controller-2:
    image: apache/kafka:latest
    networks:
      - kafka_network
    environment:
      CLUSTER_ID: "3D2ECDCE-8653-4164-A05B-50FBD8F5B915"
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: controller
      KAFKA_LISTENERS: CONTROLLER://:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@controller-1:9093,2@controller-2:9093,3@controller-3:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    volumes:
      - controller-2_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == controller-2

  controller-3:
    image: apache/kafka:latest
    networks:
      - kafka_network
    environment:
      CLUSTER_ID: "3D2ECDCE-8653-4164-A05B-50FBD8F5B915"
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: controller
      KAFKA_LISTENERS: CONTROLLER://:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@controller-1:9093,2@controller-2:9093,3@controller-3:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    volumes:
      - controller-3_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == controller-3

  broker-1:
    image: apache/kafka:latest
    networks:
      - kafka_network
    environment:
      CLUSTER_ID: "3D2ECDCE-8653-4164-A05B-50FBD8F5B915"
      KAFKA_NODE_ID: 4
      KAFKA_PROCESS_ROLES: broker
      # The PLAINTEXT_HOST listener, which is typically used for external connections,
      # has been removed. All clients for this Kafka cluster are expected to be internal
      # services connecting through the Docker Swarm overlay network.
      KAFKA_LISTENERS: 'PLAINTEXT://:19092'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://broker-1:19092'
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@controller-1:9093,2@controller-2:9093,3@controller-3:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    volumes:
      - broker-1_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == broker-1

  broker-2:
    image: apache/kafka:latest
    networks:
      - kafka_network
    environment:
      CLUSTER_ID: "3D2ECDCE-8653-4164-A05B-50FBD8F5B915"
      KAFKA_NODE_ID: 5
      KAFKA_PROCESS_ROLES: broker
      # The PLAINTEXT_HOST listener, which is typically used for external connections,
      # has been removed. All clients for this Kafka cluster are expected to be internal
      # services connecting through the Docker Swarm overlay network.
      KAFKA_LISTENERS: 'PLAINTEXT://:19092'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://broker-2:19092'
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@controller-1:9093,2@controller-2:9093,3@controller-3:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    volumes:
      - broker-2_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == broker-2

  broker-3:
    image: apache/kafka:latest
    networks:
      - kafka_network
    environment:
      CLUSTER_ID: "3D2ECDCE-8653-4164-A05B-50FBD8F5B915"
      KAFKA_NODE_ID: 6
      KAFKA_PROCESS_ROLES: broker
      # The PLAINTEXT_HOST listener, which is typically used for external connections,
      # has been removed. All clients for this Kafka cluster are expected to be internal
      # services connecting through the Docker Swarm overlay network.
      KAFKA_LISTENERS: 'PLAINTEXT://:19092'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://broker-3:19092'
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@controller-1:9093,2@controller-2:9093,3@controller-3:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    volumes:
      - broker-3_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == broker-3

networks:
  kafka_network:
    driver: overlay
  traefik_network:
    external: true

volumes:
  controller-1_data:
  controller-2_data:
  controller-3_data:
  broker-1_data:
  broker-2_data:
  broker-3_data:
