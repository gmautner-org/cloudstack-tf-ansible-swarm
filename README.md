# CloudStack Terraform + Ansible Docker Swarm Template

This project provides a reusable template for deploying a Docker Swarm cluster on CloudStack. It uses Terraform for infrastructure provisioning and Ansible for configuring the Swarm cluster and deploying services.

## Features

- **Infrastructure as Code**: Defines the entire infrastructure (VMs, networks, load balancers) in Terraform.
- **Automated Configuration**: Uses Ansible to set up Docker Swarm, configure nodes, and deploy stacks.
- **Reusable Base Stacks**: Includes optional, pre-configured base stacks for networking, reverse proxy (Traefik), and monitoring (Prometheus, Grafana, Loki).
- **Customizable**: Easily extendable with your own application stacks.
- **CI/CD Ready**: Comes with example GitHub Actions workflows for automated deployment and destruction.
- **Simplified Workflow**: A `Makefile` provides simple commands for common operations.

## How to Use This Template

1.  **Create Your Repository**: Click the "Use this template" button at the top of the repository page to create a new repository based on this template.
2.  **Clone Your Repository**: Clone the new repository to your local machine.

    ```bash
    git clone https://github.com/your-username/your-new-repo.git
    cd your-new-repo
    ```

## Quick Start

### 1. Prerequisites

- Terraform >= 1.0
- Ansible >= 2.10
- CloudStack API Credentials
- An SSH key pair

### 2. Configure Credentials

Export your CloudStack API credentials as environment variables:

```bash
export CLOUDSTACK_API_URL="your-cloudstack-api-url"
export CLOUDSTACK_API_KEY="your-api-key"
export CLOUDSTACK_SECRET_KEY="your-secret-key"
```

### 3. Configure Your Cluster

- **Terraform Variables**: Copy `terraform/terraform.tfvars.example` to `terraform/terraform.tfvars` and customize it, especially the `ssh_public_key`.

    ```bash
    cp terraform/terraform.tfvars.example terraform/terraform.tfvars
    ```

- **Ansible Variables (Optional)**: To override default settings, such as which base stacks to deploy, create a `ansible/vars.yml` file and define your variables there.

    ```yaml
    # ansible/vars.yml
    deploy_traefik: true
    deploy_monitoring: false
    ```

### 4. Deploy

Use the `Makefile` to deploy your entire infrastructure and stacks with a single command:

```bash
make deploy
```

This will:
1.  Initialize Terraform and apply the configuration to create the CloudStack resources.
2.  Generate an Ansible inventory file.
3.  Run the Ansible playbook to configure Docker Swarm and deploy the stacks.

## Project Structure

- `.github/workflows/`: Example GitHub Actions workflows.
- `ansible/`: Ansible configuration.
  - `base_stacks/`: Core, reusable stacks (networks, traefik, monitoring).
  - `stacks/`: Your custom application stacks (examples included).
  - `playbook.yml`: The main Ansible playbook.
  - `inventory.yml`: Ansible inventory file (generated by Terraform).
- `terraform/`: Terraform configuration for the CloudStack infrastructure.
- `Makefile`: Simplified commands for deployment and management.

## Customization

### Adding Your Own Stacks

Place your Docker Compose files for your applications inside the `ansible/stacks/` directory. The Ansible playbook will automatically find and deploy any `docker-compose.yml` files in this directory.

### Enabling/Disabling Base Stacks

You can control which base stacks are deployed by setting variables. The defaults are in `ansible/playbook.yml`. You can override them by creating an `ansible/inventory.yml` with a `[all:vars]` section, for example:

```yaml
# ansible/inventory.yml
all:
  vars:
    deploy_traefik: true
    deploy_monitoring: false
```

The playbook looks for `ansible/base_stacks/00-networks`, `ansible/base_stacks/01-traefik` and `ansible/base_stacks/02-monitoring`. It will always deploy the `00-networks` stack.

## CI/CD with GitHub Actions

This template includes two example workflows in `.github/workflows/`:

- `deploy.yml`: Triggered on push to `main`. Deploys the infrastructure and stacks.
- `destroy.yml`: Triggered manually. Destroys the infrastructure.

To use them, you need to add the following secrets to your GitHub repository settings:

- `CLOUDSTACK_API_URL`
- `CLOUDSTACK_API_KEY`
- `CLOUDSTACK_SECRET_KEY`
- `SSH_PRIVATE_KEY`: The private key for SSH access to the nodes.
- `DOCKER_REGISTRY_URL` (optional)
- `DOCKER_REGISTRY_USERNAME` (optional)
- `DOCKER_REGISTRY_PASSWORD` (optional)

## Updating Your Repository

To get updates from this template repository, add it as an `upstream` remote:

```bash
git remote add upstream https://github.com/gmautner/cloudstack-tf-ansible-swarm.git
```

Then, you can fetch and merge updates:

```bash
git fetch upstream
git merge upstream/main
```

## Makefile Commands

- `make help`: Show available commands.
- `make deploy`: Deploy the infrastructure and stacks.
- `make destroy`: Destroy the infrastructure.
- `make ssh`: SSH into the first manager node.

## Cleaning Up

To destroy all resources created by this project, run:

```bash
make destroy
```

**Warning**: This will permanently delete all VMs, volumes, and other resources.
