# CloudStack Terraform + Ansible Docker Swarm Template

This project provides a reusable template for deploying a Docker Swarm cluster on CloudStack. It uses Terraform for infrastructure provisioning and Ansible for configuring the Swarm cluster and deploying services.

## Features

- **Infrastructure as Code**: Defines the entire infrastructure (VMs, networks, load balancers) in Terraform.
- **Automated Configuration**: Uses Ansible to set up Docker Swarm, configure nodes, and deploy stacks.
- **Reusable Base Stacks**: Includes optional, pre-configured base stacks for networking, reverse proxy (Traefik), and monitoring (Prometheus, Grafana, Loki).
- **Customizable**: Easily extendable with your own application stacks.
- **CI/CD Ready**: Comes with example GitHub Actions workflows for automated deployment and destruction.
- **Simplified Workflow**: A `Makefile` provides simple commands for common operations.

## How to Use This Template

1.  **Create Your Repository**: Click the "Use this template" button at the top of the repository page to create a new repository based on this template.
2.  **Clone Your Repository**: Clone the new repository to your local machine.

    ```bash
    git clone https://github.com/your-username/your-new-repo.git
    cd your-new-repo
    ```

## Quick Start

### 1. Prerequisites

- Terraform >= 1.0
- Ansible >= 2.10
- CloudStack API Credentials
- An SSH key pair

### 2. Configure Credentials

Export your CloudStack API credentials as environment variables:

```bash
export CLOUDSTACK_API_URL="your-cloudstack-api-url"
export CLOUDSTACK_API_KEY="your-api-key"
export CLOUDSTACK_SECRET_KEY="your-secret-key"
```

### 3. Configure Your Cluster

- **Terraform Variables**: Copy `terraform/terraform.tfvars.example` to `terraform/terraform.tfvars` and customize it, especially the `ssh_public_key`.

    ```bash
    cp terraform/terraform.tfvars.example terraform/terraform.tfvars
    ```

### 4. Deploy

Use the `Makefile` to deploy your entire infrastructure and stacks with a single command:

```bash
make deploy
```

This will:
1.  Initialize Terraform and apply the configuration to create the CloudStack resources.
2.  Generate an Ansible inventory file.
3.  Run the Ansible playbook to configure Docker Swarm and deploy the stacks.

## Project Structure

- `.github/workflows/`: Example GitHub Actions workflows.
- `ansible/`: Ansible configuration.
  - `example_stacks/`: A collection of all available stacks (base services and applications).
  - `stacks/`: The directory where you place the stacks you want to deploy.
  - `playbook.yml`: The main Ansible playbook.
  - `inventory.yml`: Ansible inventory file (generated by Terraform).
- `terraform/`: Terraform configuration for the CloudStack infrastructure.
- `Makefile`: Simplified commands for deployment and management.

## Customization

### Selecting Stacks to Deploy

This template provides a collection of pre-configured stacks in the `ansible/example_stacks` directory. To deploy a stack, simply copy its subdirectory into the `ansible/stacks` directory.

For example, to deploy Traefik and Portainer, you would also need the base networks:

```bash
cp -r ansible/example_stacks/00-networks ansible/stacks/
cp -r ansible/example_stacks/01-traefik ansible/stacks/
cp -r ansible/example_stacks/portainer ansible/stacks/
```

The Ansible playbook will automatically deploy all stacks found in the `ansible/stacks` directory. The numbered prefixes on some stacks (e.g., `00-networks`, `01-traefik`) ensure they are deployed in the correct order.

### Adding Your Own Stacks

To add your own application, create a new subdirectory within `ansible/stacks/`. Inside this new folder, place your `docker-compose.yml` file.

For example, to add a new stack called `my-app`, you would create the following structure:

```
ansible/
└── stacks/
    └── my-app/
        └── docker-compose.yml
```

The playbook will automatically find and deploy it. You can also add your new stacks to `ansible/example_stacks` to keep them as reference.

### Managing Secrets

Application secrets (like database passwords or API keys) are managed via Ansible. This template uses environment variables to create Docker Swarm secrets, which are then securely mounted into your service containers.

To configure your secrets:

1.  **Copy the Example File**: Copy `ansible/secrets/secrets.yaml.example` to `ansible/secrets/secrets.yaml`.

    ```bash
    cp ansible/secrets/secrets.yaml.example ansible/secrets/secrets.yaml
    ```

2.  **Define Your Secrets**: Edit `ansible/secrets/secrets.yaml` to define the secrets your applications need. Each secret is mapped to an environment variable that you will need to set.

    ```yaml
    # ansible/secrets/secrets.yaml
    docker_secrets:
      - name: mysql_root_password
        env_var: MYSQL_ROOT_PASSWORD
      - name: wordpress_db_password
        env_var: WORDPRESS_DB_PASSWORD
    ```

3.  **Set Environment Variables**: Before running `make deploy`, export the environment variables corresponding to your secrets.

    ```bash
    export MYSQL_ROOT_PASSWORD="your-secure-root-password"
    export WORDPRESS_DB_PASSWORD="your-secure-db-password"
    ```

The `ansible/secrets/secrets.yaml` file is included in `.gitignore` to prevent you from accidentally committing your secrets to version control.

## CI/CD with GitHub Actions

This template includes two example workflows in `.github/workflows/`:

- `deploy.yml`: Triggered on push to `main`. Deploys the infrastructure and stacks.
- `destroy.yml`: Triggered manually. Destroys the infrastructure.

To use them, you need to add the following secrets to your GitHub repository settings:

- `CLOUDSTACK_API_URL`
- `CLOUDSTACK_API_KEY`
- `CLOUDSTACK_SECRET_KEY`
- `SSH_PRIVATE_KEY`: The private key for SSH access to the nodes.
- `DOCKER_REGISTRY_URL` (optional)
- `DOCKER_REGISTRY_USERNAME` (optional)
- `DOCKER_REGISTRY_PASSWORD` (optional)

## Updating Your Repository

To get updates from this template repository, add it as an `upstream` remote:

```bash
git remote add upstream https://github.com/gmautner/cloudstack-tf-ansible-swarm.git
```

Then, you can fetch and merge updates:

```bash
git fetch upstream
git merge upstream/main
```

## Makefile Commands

- `make help`: Show available commands.
- `make deploy`: Deploy the infrastructure and stacks.
- `make destroy`: Destroy the infrastructure.
- `make ssh`: SSH into the first manager node.

## Cleaning Up

To destroy all resources created by this project, run:

```bash
make destroy
```

**Warning**: This will permanently delete all VMs, volumes, and other resources.
